#include "zpc/shm.h"

#include "zpc/fatal.h"

#include <errno.h>
#include <fcntl.h>
#include <stdlib.h>
#include <string.h>
#include <sys/mman.h>
#include <sys/stat.h>
#include <unistd.h>

// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
struct shared_mem_segment_zt
{
    int fd;
    void* ptr;
    size_t size;
    bool is_creator;
    char* name;
};

// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
shared_mem_segment_zh shared_mem_create_z(const char* name, size_t size)
{
    // =============================================================================================
    // =============================================================================================
    // Guard: Validate inputs.
    // =============================================================================================
    // =============================================================================================
    {
        fatal_check_z(name, "name is null");
        fatal_check_bool_z(size > 0, "size must be greater than 0");
    }

    // =============================================================================================
    // =============================================================================================
    // Allocate segment structure.
    // =============================================================================================
    // =============================================================================================
    struct shared_mem_segment_zt* seg = (struct shared_mem_segment_zt*)fatal_alloc_z(sizeof(struct shared_mem_segment_zt), "failed to allocate shared_mem_segment");
    {
        seg->fd         = -1;
        seg->ptr        = nullptr;
        seg->size       = size;
        seg->is_creator = true;
        seg->name       = nullptr;
    }

    // =============================================================================================
    // =============================================================================================
    // Store name.
    // =============================================================================================
    // =============================================================================================
    {
        size_t name_len = strlen(name);
        seg->name       = (char*)fatal_alloc_z(name_len + 1, "failed to allocate shared memory name");
        memcpy(seg->name, name, name_len + 1);
    }

    // =============================================================================================
    // =============================================================================================
    // Create shared memory object.
    // =============================================================================================
    // =============================================================================================
    {
        seg->fd = shm_open(name, O_CREAT | O_RDWR | O_EXCL, 0666);
        if (seg->fd < 0)
        {
            if (errno == EEXIST)
            {
                fatal_z("shared memory segment '%s' already exists", name);
            }
            fatal_z("failed to create shared memory segment '%s': %s", name, strerror(errno));
        }
    }

    // =============================================================================================
    // =============================================================================================
    // Set size of shared memory object.
    // =============================================================================================
    // =============================================================================================
    {
        if (ftruncate(seg->fd, (off_t)size) != 0)
        {
            close(seg->fd);
            shm_unlink(name);
            fatal_z("failed to set size of shared memory segment '%s': %s", name, strerror(errno));
        }
    }

    // =============================================================================================
    // =============================================================================================
    // Map shared memory into address space.
    // =============================================================================================
    // =============================================================================================
    {
        seg->ptr = mmap(nullptr, size, PROT_READ | PROT_WRITE, MAP_SHARED, seg->fd, 0);
        if (seg->ptr == MAP_FAILED)
        {
            close(seg->fd);
            shm_unlink(name);
            fatal_z("failed to mmap shared memory segment '%s': %s", name, strerror(errno));
        }
    }

    return seg;
}

// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
shared_mem_segment_zh shared_mem_open_z(const char* name)
{
    // =============================================================================================
    // =============================================================================================
    // Guard: Validate inputs.
    // =============================================================================================
    // =============================================================================================
    {
        fatal_check_z(name, "name is null");
    }

    // =============================================================================================
    // =============================================================================================
    // Allocate segment structure.
    // =============================================================================================
    // =============================================================================================
    struct shared_mem_segment_zt* seg = (struct shared_mem_segment_zt*)fatal_alloc_z(sizeof(struct shared_mem_segment_zt), "failed to allocate shared_mem_segment");
    {
        seg->fd         = -1;
        seg->ptr        = nullptr;
        seg->size       = 0;
        seg->is_creator = false;
        seg->name       = nullptr;
    }

    // =============================================================================================
    // =============================================================================================
    // Store name.
    // =============================================================================================
    // =============================================================================================
    {
        size_t name_len = strlen(name);
        seg->name       = (char*)fatal_alloc_z(name_len + 1, "failed to allocate shared memory name");
        memcpy(seg->name, name, name_len + 1);
    }

    // =============================================================================================
    // =============================================================================================
    // Open existing shared memory object.
    // =============================================================================================
    // =============================================================================================
    {
        seg->fd = shm_open(name, O_RDWR, 0);
        if (seg->fd < 0)
        {
            if (errno == ENOENT)
            {
                fatal_z("shared memory segment '%s' does not exist", name);
            }
            fatal_z("failed to open shared memory segment '%s': %s", name, strerror(errno));
        }
    }

    // =============================================================================================
    // =============================================================================================
    // Get size of shared memory object.
    // =============================================================================================
    // =============================================================================================
    {
        struct stat st;
        if (fstat(seg->fd, &st) != 0)
        {
            close(seg->fd);
            fatal_z("failed to stat shared memory segment '%s': %s", name, strerror(errno));
        }
        seg->size = (size_t)st.st_size;
    }

    // =============================================================================================
    // =============================================================================================
    // Map shared memory into address space.
    // =============================================================================================
    // =============================================================================================
    {
        seg->ptr = mmap(nullptr, seg->size, PROT_READ | PROT_WRITE, MAP_SHARED, seg->fd, 0);
        if (seg->ptr == MAP_FAILED)
        {
            close(seg->fd);
            fatal_z("failed to mmap shared memory segment '%s': %s", name, strerror(errno));
        }
    }

    return seg;
}

// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
void* shared_mem_get_ptr_z(shared_mem_segment_zh seg)
{
    // =============================================================================================
    // =============================================================================================
    // Guard: Validate inputs.
    // =============================================================================================
    // =============================================================================================
    {
        fatal_check_z(seg, "seg is null");
        fatal_check_z(seg->ptr, "seg->ptr is null");
    }

    return seg->ptr;
}

// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
size_t shared_mem_get_size_z(shared_mem_segment_zh seg)
{
    // =============================================================================================
    // =============================================================================================
    // Guard: Validate inputs.
    // =============================================================================================
    // =============================================================================================
    {
        fatal_check_z(seg, "seg is null");
        fatal_check_bool_z(seg->size > 0, "shared memory segment has zero size");
    }

    return seg->size;
}

// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
void shared_mem_close_z(shared_mem_segment_zh seg)
{
    // =============================================================================================
    // =============================================================================================
    // Guard: Validate inputs.
    // =============================================================================================
    // =============================================================================================
    {
        fatal_check_z(seg, "seg is null");
    }

    // =============================================================================================
    // =============================================================================================
    // Unmap shared memory.
    // =============================================================================================
    // =============================================================================================
    {
        if (seg->ptr != nullptr)
        {
            if (munmap(seg->ptr, seg->size) != 0)
            {
                fatal_z("failed to munmap shared memory segment '%s': %s", seg->name ? seg->name : "<unknown>", strerror(errno));
            }
            seg->ptr = nullptr;
        }
    }

    // =============================================================================================
    // =============================================================================================
    // Close file descriptor.
    // =============================================================================================
    // =============================================================================================
    {
        if (seg->fd >= 0)
        {
            if (close(seg->fd) != 0)
            {
                fatal_z("failed to close shared memory file descriptor: %s", strerror(errno));
            }
            seg->fd = -1;
        }
    }

    // =============================================================================================
    // =============================================================================================
    // Free name.
    // =============================================================================================
    // =============================================================================================
    {
        if (seg->name != nullptr)
        {
            free(seg->name);
            seg->name = nullptr;
        }
    }

    // =============================================================================================
    // =============================================================================================
    // Free segment structure.
    // =============================================================================================
    // =============================================================================================
    {
        free(seg);
    }
}

// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
void shared_mem_unlink_z(const char* name)
{
    // =============================================================================================
    // =============================================================================================
    // Guard: Validate inputs.
    // =============================================================================================
    // =============================================================================================
    {
        fatal_check_z(name, "name is null");
    }

    // =============================================================================================
    // =============================================================================================
    // Unlink shared memory object.
    // =============================================================================================
    // =============================================================================================
    {
        if (shm_unlink(name) != 0)
        {
            if (errno == ENOENT)
            {
                fatal_z("shared memory segment '%s' does not exist", name);
            }
            fatal_z("failed to unlink shared memory segment '%s': %s", name, strerror(errno));
        }
    }
}
