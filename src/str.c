#include "zpc/str.h"

#include <stdarg.h>
#include <stdio.h>
#include <string.h>

// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
bool str_from_cstr_z(arena_zh arena, str_zt* str, size_t count, ...)
{
    // =============================================================================================
    // =============================================================================================
    // Validate inputs and check that all strings are non-null.
    // =============================================================================================
    // =============================================================================================
    {
        if (str == nullptr || count == 0U)
        {
            return false;
        }

        {
            va_list va;
            va_start(va, count);
            for (size_t i = 0; i < count; i++)
            {
                if (va_arg(va, char*) == nullptr)
                {
                    va_end(va);
                    return false;
                }
            }
            va_end(va);
        }
    }

    // =============================================================================================
    // =============================================================================================
    // Calculate total size needed for concatenated string including null
    // terminator.
    // =============================================================================================
    // =============================================================================================
    size_t total_size;
    {
        total_size = NULL_TERM_SIZE;

        va_list va;
        va_start(va, count);
        for (size_t i = 0; i < count; i++)
        {
            char* c_str  = va_arg(va, char*);
            total_size  += strlen(c_str);
        }
        va_end(va);
    }

    span_zh alloc = arena_alloc_z(arena, total_size);

    // =============================================================================================
    // =============================================================================================
    // Concatenate all strings into the allocated buffer.
    // =============================================================================================
    // =============================================================================================
    {
        char* dest = (char*)alloc->data;

        va_list va;
        va_start(va, count);
        for (size_t i = 0; i < count; i++)
        {
            char* c_str = va_arg(va, char*);
            size_t len  = strlen(c_str);
            memcpy(dest, c_str, len);
            dest += len;
        }
        va_end(va);

        *dest = '\0';
    }

    // =============================================================================================
    // =============================================================================================
    // Set output str structure with allocated data and size.
    // =============================================================================================
    // =============================================================================================
    {
        str->data = (char*)alloc->data;
        str->size = alloc->size;
    }

    return true;
}
// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
void sb_init_z(string_builder_zt* sb, arena_zh arena, size_t initial_capacity)
{
    sb->arena    = arena;
    sb->capacity = initial_capacity;
    sb->size     = 0;
    span_zh span = arena_alloc_z(arena, initial_capacity);
    sb->data     = (char*)span->data;
    sb->data[0]  = '\0';
}

// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
void sb_ensure_capacity_z(string_builder_zt* sb, size_t additional)
{
    size_t required = sb->size + additional + 1;
    if (required > sb->capacity)
    {
        size_t new_capacity = sb->capacity * 2;
        if (new_capacity < required)
        {
            new_capacity = required;
        }
        span_zh span   = arena_alloc_z(sb->arena, new_capacity);
        char* new_data = (char*)span->data;
        memcpy(new_data, sb->data, sb->size + 1);
        sb->data     = new_data;
        sb->capacity = new_capacity;
    }
}

// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
void sb_append_z(string_builder_zt* sb, const char* str)
{
    size_t len = strlen(str);
    sb_ensure_capacity_z(sb, len);
    memcpy(sb->data + sb->size, str, len + 1);
    sb->size += len;
}

// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
void sb_append_fmt_z(string_builder_zt* sb, const char* fmt, ...)
{
    va_list args;
    va_start(args, fmt);
    va_list args_copy;
    va_copy(args_copy, args);
    int len = vsnprintf(nullptr, 0, fmt, args_copy);
    va_end(args_copy);

    sb_ensure_capacity_z(sb, (size_t)len);
    vsnprintf(sb->data + sb->size, (size_t)len + 1, fmt, args);
    sb->size += (size_t)len;
    va_end(args);
}