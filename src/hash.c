#include "zpc/hash.h"

#include <openssl/evp.h>
#include <string.h>

// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
hash_sha256_zt hash_sha256_z(const void* data, size_t len)
{
    // =============================================================================================
    // =============================================================================================
    // Initialize OpenSSL digest context and select SHA-256 algorithm.
    // =============================================================================================
    // =============================================================================================
    EVP_MD_CTX* mdctx;
    const EVP_MD* md;
    {
        mdctx = EVP_MD_CTX_new();
        md    = EVP_sha256();
    }

    // =============================================================================================
    // =============================================================================================
    // Compute hash by initializing, updating with data, and finalizing digest.
    // =============================================================================================
    // =============================================================================================
    hash_sha256_zt result;
    unsigned int hash_len;
    {
        memset(&result, 0, sizeof(result));

        EVP_DigestInit_ex(mdctx, md, nullptr);
        EVP_DigestUpdate(mdctx, data, len);
        EVP_DigestFinal_ex(mdctx, result.bytes, &hash_len);
    }

    // =============================================================================================
    // =============================================================================================
    // Cleanup digest context.
    // =============================================================================================
    // =============================================================================================
    {
        EVP_MD_CTX_free(mdctx);
    }

    return result;
}
