#include "zpc/list.h"

#include <stdint.h>
#include <string.h>

#include "zpc/fatal.h"

// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
struct list_zt
{
    void* data;
    size_t count;
    size_t capacity;
    size_t element_size;
    arena_zh arena;
};

// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
list_zh list_init_z(arena_zh arena, size_t element_size, size_t initial_capacity)
{
    // =============================================================================================
    // =============================================================================================
    // Validate inputs.
    // =============================================================================================
    // =============================================================================================
    {
        fatal_check_z(arena, "arena is null");
        fatal_check_bool_z(element_size > 0U, "element_size must be greater than zero");
        fatal_check_bool_z(initial_capacity > 0U, "initial_capacity must be greater than zero");
    }

    // =============================================================================================
    // =============================================================================================
    // Allocate list structure on arena.
    // =============================================================================================
    // =============================================================================================
    list_zh list;
    {
        span_zh list_span = arena_alloc_z(arena, sizeof(struct list_zt));
        list              = (list_zh)list_span->data;
    }

    // =============================================================================================
    // =============================================================================================
    // Allocate initial buffer from arena.
    // =============================================================================================
    // =============================================================================================
    void* data;
    {
        size_t buffer_size = element_size * initial_capacity;
        span_zh span       = arena_alloc_z(arena, buffer_size);
        data               = span->data;
    }

    // =============================================================================================
    // =============================================================================================
    // Initialize list structure.
    // =============================================================================================
    // =============================================================================================
    {
        list->data         = data;
        list->count        = 0U;
        list->capacity     = initial_capacity;
        list->element_size = element_size;
        list->arena        = arena;
    }

    return list;
}

// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
static void list_grow_z(list_zh list)
{
    // =============================================================================================
    // =============================================================================================
    // Calculate new capacity (double the current capacity).
    // =============================================================================================
    // =============================================================================================
    size_t new_capacity;
    {
        fatal_check_bool_z(list->capacity <= SIZE_MAX / 2U, "capacity overflow when doubling");
        new_capacity = list->capacity * 2U;
    }

    // =============================================================================================
    // =============================================================================================
    // Allocate new buffer from arena.
    // =============================================================================================
    // =============================================================================================
    void* new_data;
    {
        fatal_check_bool_z(new_capacity <= SIZE_MAX / list->element_size, "buffer size overflow");
        size_t buffer_size = list->element_size * new_capacity;
        span_zh span       = arena_alloc_z(list->arena, buffer_size);
        new_data           = span->data;
    }

    // =============================================================================================
    // =============================================================================================
    // Copy existing data to new buffer.
    // =============================================================================================
    // =============================================================================================
    {
        size_t existing_size = list->element_size * list->count;
        memcpy(new_data, list->data, existing_size);
    }

    // =============================================================================================
    // =============================================================================================
    // Update list to use new buffer and capacity.
    // =============================================================================================
    // =============================================================================================
    {
        list->data     = new_data;
        list->capacity = new_capacity;
    }
}

// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
void list_push_z(list_zh list, const void* element)
{
    // =============================================================================================
    // =============================================================================================
    // Validate inputs.
    // =============================================================================================
    // =============================================================================================
    {
        fatal_check_z(list, "list is null");
        fatal_check_z(element, "element is null");
    }

    // =============================================================================================
    // =============================================================================================
    // Grow list if capacity is full.
    // =============================================================================================
    // =============================================================================================
    {
        if (list->count >= list->capacity)
        {
            list_grow_z(list);
        }
    }

    // =============================================================================================
    // =============================================================================================
    // Copy element into list at current count position.
    // =============================================================================================
    // =============================================================================================
    {
        void* dest = (uint8_t*)list->data + (list->count * list->element_size);
        memcpy(dest, element, list->element_size);
        list->count++;
    }
}

// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
size_t list_count_z(list_zh list)
{
    fatal_check_z(list, "list is null");
    return list->count;
}

// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
size_t list_capacity_z(list_zh list)
{
    fatal_check_z(list, "list is null");
    return list->capacity;
}

// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
void* list_get_z(list_zh list, size_t index)
{
    // =============================================================================================
    // =============================================================================================
    // Validate inputs and check bounds.
    // =============================================================================================
    // =============================================================================================
    {
        fatal_check_z(list, "list is null");
        fatal_check_bool_z(index < list->count, "index out of bounds");
    }

    // =============================================================================================
    // =============================================================================================
    // Calculate and return pointer to element at index.
    // =============================================================================================
    // =============================================================================================
    {
        return (uint8_t*)list->data + (index * list->element_size);
    }
}

// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
void list_clear_z(list_zh list)
{
    fatal_check_z(list, "list is null");
    list->count = 0U;
}

// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
void* list_data_z(list_zh list)
{
    fatal_check_z(list, "list is null");
    return list->data;
}
