#include "zpc/arena.h"

#include <stdalign.h>
#include <stdint.h>
#include <stdlib.h>
#include <string.h>

#include "zpc/fatal.h"

struct arena_zt
{
    bool init;
    uint8_t* buffer;
    size_t capacity;
    size_t offset;
};

// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
static size_t align_offset_z(size_t offset)
{
    return (offset + alignof(max_align_t) - 1) & ~(alignof(max_align_t) - 1);
}

// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
arena_zh arena_init_z(size_t capacity)
{
    // =============================================================================================
    // =============================================================================================
    // Allocate arena buffer and arena structure.
    // =============================================================================================
    // =============================================================================================
    void* buf;
    arena_zh arena;
    {
        buf   = fatal_alloc_z(capacity, "failed to allocate arena buffer");
        arena = fatal_alloc_z(sizeof(struct arena_zt), "failed to allocate arena");
    }

    // =============================================================================================
    // =============================================================================================
    // Initialize arena fields.
    // =============================================================================================
    // =============================================================================================
    {
        arena->init     = true;
        arena->buffer   = buf;
        arena->capacity = capacity;
        arena->offset   = 0;
    }

    return arena;
}

// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
void arena_destroy_z(arena_zh arena)
{
    // =============================================================================================
    // =============================================================================================
    // Validate arena state.
    // =============================================================================================
    // =============================================================================================
    {
        fatal_check_z(arena, "arena is null");
        fatal_check_bool_z(arena->init, "arena is not initialized");
    }

    // =============================================================================================
    // =============================================================================================
    // Free arena buffer and arena structure.
    // =============================================================================================
    // =============================================================================================
    {
        free(arena->buffer);
        free(arena);
    }
}

// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
span_zh arena_alloc_z(arena_zh arena, size_t size)
{
    // =============================================================================================
    // =============================================================================================
    // Validate arena state.
    // =============================================================================================
    // =============================================================================================
    {
        fatal_check_z(arena, "arena is null");
        fatal_check_bool_z(arena->init, "arena is not initialized");
    }

    // =============================================================================================
    // =============================================================================================
    // Calculate aligned offset for span structure.
    // =============================================================================================
    // =============================================================================================
    size_t span_aligned_offset;
    {
        span_aligned_offset = align_offset_z(arena->offset);
        fatal_check_bool_z(span_aligned_offset <= arena->capacity, "arena offset overflow");
    }

    // =============================================================================================
    // =============================================================================================
    // Calculate aligned offset for data after span structure.
    // =============================================================================================
    // =============================================================================================
    size_t data_aligned_offset;
    {
        fatal_check_bool_z(span_aligned_offset <= SIZE_MAX - sizeof(struct span_zt), "span size overflow");
        size_t after_span   = span_aligned_offset + sizeof(struct span_zt);
        data_aligned_offset = align_offset_z(after_span);
    }

    // =============================================================================================
    // =============================================================================================
    // Validate that allocation fits in arena capacity.
    // =============================================================================================
    // =============================================================================================
    {
        fatal_check_bool_z(data_aligned_offset <= SIZE_MAX - size, "allocation size overflow");
        fatal_check_bool_z(data_aligned_offset + size <= arena->capacity, "arena is full");
    }

    struct span_zt* span = (struct span_zt*)(arena->buffer + span_aligned_offset);

    // =============================================================================================
    // =============================================================================================
    // Initialize span structure and update arena offset.
    // =============================================================================================
    // =============================================================================================
    {
        span->data    = arena->buffer + data_aligned_offset;
        span->size    = size;
        arena->offset = data_aligned_offset + size;
    }

    return (span_zh)span;
}

// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
void arena_reset_z(arena_zh arena)
{
    // =============================================================================================
    // =============================================================================================
    // Validate arena state.
    // =============================================================================================
    // =============================================================================================
    {
        fatal_check_z(arena, "arena is null");
        fatal_check_bool_z(arena->init, "arena is not initialized");
    }

    arena->offset = 0;
}

// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
// =========================================================================================================================================
char* arena_strdup_z(arena_zh arena, const char* str)
{
    // =============================================================================================
    // =============================================================================================
    // Validate inputs.
    // =============================================================================================
    // =============================================================================================
    {
        fatal_check_z(arena, "arena is null");
        fatal_check_bool_z(arena->init, "arena is not initialized");
        fatal_check_z(str, "str is null");
    }

    // =============================================================================================
    // =============================================================================================
    // Allocate space for string and copy contents.
    // =============================================================================================
    // =============================================================================================
    char* result;
    {
        size_t len   = strlen(str);
        span_zh span = arena_alloc_z(arena, len + 1);
        result       = (char*)span->data;
        memcpy(result, str, len + 1);
    }

    return result;
}